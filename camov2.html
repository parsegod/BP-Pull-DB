<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BO6 Camouflage Duplication Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Colors derived from style (1).css
                        'primary-dark': '#102A43',
                        'secondary-dark': '#0D3B66',
                        'accent-blue': '#0077B6',
                        'light-blue': '#00A6FB',
                        'text-light': '#e0e0e0',
                        'text-lighter': '#CCE0F0',
                        'danger-red': '#EF4444', // Tailwind's red-500
                        'success-green': '#22C55E', // Tailwind's green-500
                        'warning-orange': '#F97316', // Tailwind's orange-500
                        'cod-purple': '#800080', // New: Purple for import/export
                    }
                }
            }
        }
    </script>
    <style>
        body {
            /* Inherit gradient and animation from style (1).css */
            font-family: 'Inter', sans-serif;
            background: linear-gradient(270deg, #102A43, #0077B6);
            background-size: 400% 400%;
            color: #e0e0e0;
            line-height: 1.6;
            animation: gradientAnimation 15s ease infinite;
            overflow-x: hidden; /* Prevent horizontal scroll from confetti */
        }

        /* Keyframes for gradient animation - copied from style (1).css */
        @keyframes gradientAnimation {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Custom scrollbar for Webkit browsers (Chrome, Safari) - copied from style (1).css */
        ::-webkit-scrollbar {
          width: 0;
          height: 0;
        }

        ::-webkit-scrollbar-track {
          background: #0D3B66;
          border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
          background: #0077B6;
          border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
          background: #00A6FB;
        }

        .step-checkbox {
            /* Updated to use new Tailwind colors */
            @apply mr-3 h-5 w-5 appearance-none rounded-md border-2 border-light-blue bg-transparent
                   checked:bg-success-green checked:border-transparent checked:after:content-['\2713']
                   checked:after:text-white checked:after:flex checked:after:justify-center checked:after:items-center;
        }
        .step-item.completed label {
            text-decoration: line-through;
            color: #aaa;
        }
        .section-container, .sub-step-container {
            display: none; /* Hidden by default */
        }
        .section-container.active, .sub-step-container.active {
            display: block; /* Shown when active */
        }
        .progress-bar {
            height: 8px;
            background-color: #0D3B66; /* secondary-dark */
            border-radius: 4px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background-color: #00A6FB; /* light-blue */
            transition: width 0.3s ease-in-out;
            border-radius: 4px;
        }

        /* Confetti styles */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #00A6FB; /* light-blue */
            opacity: 0;
            animation: confetti-fall 2s forwards;
            pointer-events: none;
            border-radius: 50%; /* Make them round */
        }
        .confetti.square {
            border-radius: 0;
            background-color: #22C55E; /* success-green */
        }
        .confetti.triangle {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 10px solid #0077B6; /* accent-blue */
            border-radius: 0;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotateZ(0deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotateZ(720deg) scale(0.5);
                opacity: 0;
            }
        }
        .json-textarea {
            @apply w-full p-4 rounded-md bg-gray-800 border border-cod-purple text-text-light font-mono text-sm;
            min-height: 150px;
            resize: vertical;
        }
        /* Style for message box */
        .message-box {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .message-box-content {
            background-color: #102A43; /* primary-dark */
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
            border: 1px solid #0077B6; /* accent-blue */
            max-width: 24rem;
            width: 100%;
        }
        .message-box h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00A6FB; /* light-blue */
            margin-bottom: 1rem;
        }
        .message-box p {
            font-size: 1.125rem;
            color: #e0e0e0; /* text-light */
            margin-bottom: 1.5rem;
        }
        .message-box button {
            background-color: #0077B6; /* accent-blue */
            color: white;
            font-weight: bold;
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .message-box button:hover {
            background-color: #005f93;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="p-4 sm:p-8 md:p-12 lg:p-16">

    <div class="max-w-4xl mx-auto bg-primary-dark p-6 sm:p-8 md:p-10 rounded-2xl shadow-xl border border-accent-blue/20">

        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-light-blue mb-4 leading-tight">
                BO6 Camouflage Duplication Guide
            </h1>
            <p class="text-lg sm:text-xl text-text-light mb-6">
                Welcome! This comprehensive guide provides a step-by-step method to duplicate weapon camouflages and builds in Call of Duty: Black Ops 6. Enhance your in-game arsenal with these techniques.
            </p>
            <button id="startButton" class="bg-success-green hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Begin Guide
            </button>
            <a href="editor.html" class="inline-block mt-4 text-light-blue hover:text-success-green transition-colors duration-300">Admin Panel (Edit Guide)</a>
        </header>

        <!-- JSON Import/Export Section -->
        <section id="jsonManagementSection" class="bg-secondary-dark/70 p-6 rounded-xl mt-10 mb-6 border border-cod-purple/30">
            <h2 class="text-2xl font-bold text-cod-purple mb-4">Manage Guide Data (Advanced)</h2>
            <p class="text-text-light mb-4">
                You can import guide content by pasting JSON below, or generate a new `Camo.html` file with the current guide data "baked in" as default.
            </p>
            <textarea id="jsonInputCamo" class="json-textarea" placeholder='Paste JSON content here, e.g., [{"id": "phase_...", "title": "My Phase", "subSteps": [...]}]'></textarea>
            <button id="loadJsonBtnCamo" class="bg-cod-purple hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mt-4 w-full sm:w-auto">Load Guide from JSON</button>
            <button id="saveHtmlDefaultBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mt-4 ml-0 sm:ml-4 w-full sm:w-auto">Save Current Guide as HTML Default</button>
        </section>

        <div id="guideContent" class="hidden">
            <div class="progress-bar">
                <div id="overallProgressBarFill" class="progress-fill"></div>
            </div>
            <p class="text-right text-sm text-gray-400 mb-6" id="overallProgressText"></p>

            <div id="dynamicGuideContent">
                <p class="text-center text-text-lighter" id="initialLoadingMessage">Loading guide content...</p>
            </div>

            <section id="troubleshooting" class="bg-secondary-dark/70 p-6 rounded-xl mt-10 border border-danger-red/30">
                <h2 class="text-3xl sm:text-4xl font-bold text-danger-red mb-6 flex items-center">
                    <span class="mr-3">Troubleshooting:</span>
                </h2>


                <ul class="space-y-3">
                    <li class="flex items-start text-lg">
                        <span class="text-danger-red font-bold mr-3 mt-1"></span>
                        <p>Access <strong class="text-success-green">Multiplayer Private</strong>, <strong class="text-success-green">Zombies</strong>, and <strong class="text-success-green">Warzone</strong> modes.</p>
                    </li>
                    <li class="flex items-start text-lg">
                        <span class="text-danger-red font-bold mr-3 mt-1"></span>
                        <p><strong class="text-danger-red">Remove all existing custom classes</strong> within these modes.</p>
                    </li>
                    <li class="flex items-start text-lg">
                        <span class="text-light-blue"></span>
                        <p><strong class="text-light-blue">Create 10 new custom classes</strong> to reach the maximum limit.</p>
                    </li>
                    <li class="flex items-start text-lg">
                        <span class="text-danger-red font-bold mr-3 mt-1"></span>
                        <p>Then, reattempt the duplication steps from Phase 1. Good luck!</p>
                    </li>
                </ul>
            </section>

            <div class="text-center mt-10">
                <button id="resetButton" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 ease-in-out">
                    Reset Guide
                </button>
            </div>
        </div>

        <!-- Custom Message Box for Alerts and Code Output -->
        <div id="customMessageBox" class="message-box hidden">
            <div class="message-box-content">
                <h2 id="messageBoxTitle"></h2>
                <p id="messageBoxContent"></p>
                <textarea id="codeOutputTextarea" class="json-textarea hidden" readonly></textarea>
                <button id="closeMessageBoxBtn">OK</button>
                <button id="copyCodeBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mt-4 hidden">Copy Code</button>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const startButton = document.getElementById('startButton');
            const guideContent = document.getElementById('guideContent');
            const resetButton = document.getElementById('resetButton');
            const dynamicGuideContent = document.getElementById('dynamicGuideContent');
            const initialLoadingMessage = document.getElementById('initialLoadingMessage');

            // New JSON import/export elements
            const jsonInputCamo = document.getElementById('jsonInputCamo');
            const loadJsonBtnCamo = document.getElementById('loadJsonBtnCamo');
            const saveHtmlDefaultBtn = document.getElementById('saveHtmlDefaultBtn');

            // Custom Message Box elements
            const customMessageBox = document.getElementById('customMessageBox');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxContent = document.getElementById('messageBoxContent');
            const closeMessageBoxBtn = document.getElementById('closeMessageBoxBtn');
            const codeOutputTextarea = document.getElementById('codeOutputTextarea');
            const copyCodeBtn = document.getElementById('copyCodeBtn');


            // Local Storage Key (must match admin.html)
            const LOCAL_STORAGE_KEY = 'camoDupeAdminGuideData';
            const PROGRESS_STORAGE_KEY = 'camoDupeGuideProgress'; // Separate key for user progress

            // IMPORTANT: This defaultGuideData is what gets "baked" into the HTML file.
            // When you click "Save Current Guide as HTML Default", this array will be updated
            // in the generated HTML output.
            let defaultGuideData = [
                {
                    id: 'phase1',
                    title: 'Phase 1: Setup for Success üõ†Ô∏è',
                    subSteps: [
                        {
                            id: 'substep1-1',
                            title: 'Getting Ready (Player 1 & 2)',
                            items: [
                                'Pick <strong class="text-cod-accent">ANY Black Ops 6 weapon</strong> you don\'t mind messing around with for a bit. This is your "sacrificial lamb" for the glitch. üêë',
                                'Head into <strong class="text-cod-green">Public Warzone</strong>.',
                            ]
                        },
                        {
                            id: 'substep1-2',
                            title: 'Initial Settings',
                            items: [
                                '<strong class="text-cod-accent">Duplicate this BO6 weapon 3 times.</strong> Yes, three! ‚ú®',
                                'Place <strong class="text-cod-green">one duplicate</strong> in your <strong class="text-cod-green">Public Warzone</strong> loadouts.',
                                'Place <strong class="text-cod-green">another</strong> into your <strong class="text-cod-green">Public Zombies</strong> loadouts.',
                                'And the <strong class="text-cod-green">last one</strong> into your <strong class="text-cod-green">Private Multiplayer</strong> loadouts. Got it? Good! üëç'
                            ]
                        }
                    ]
                },
                {
                    id: 'phase2',
                    title: 'Phase 2: The Duplication Dance üëØ',
                    subSteps: [
                        {
                            id: 'substep2-1',
                            title: 'The Lobby Shuffle',
                            items: [
                                'Player 1: Go to the "Create a Class" section.',
                                'Player 2: Stay in the private match lobby, doing nothing.',
                                'Player 1: Select the weapon you want to duplicate the camo/build onto.'
                            ]
                        },
                        {
                            id: 'substep2-2',
                            title: 'Execution',
                            items: [
                                'Player 1: Apply the camo/build you want to duplicate.',
                                'Player 2: At the EXACT moment Player 1 applies the camo, leave the private match lobby.',
                                'Player 1: Quickly back out to the main menu before the game registers Player 2\'s departure.',
                                'Check your weapon\'s camo. If done correctly, it should now have the duplicated camo/build!'
                            ]
                        }
                    ]
                },
                {
                    id: 'phase3',
                    title: 'Phase 3: Verify and Conquer! ‚úÖ',
                    subSteps: [
                        {
                            id: 'substep3-1',
                            title: 'Confirmation',
                            items: [
                                'Go to your loadouts in any game mode (Multiplayer, Zombies, Warzone).',
                                'Verify that the duplicated camo/build is applied to the selected weapon.',
                                'Enjoy your new, shiny weapon!'
                            ]
                        },
                         {
                            id: 'substep3-2',
                            title: 'Repeat for More',
                            items: [
                                'You can repeat this process for other weapons and builds.',
                                'Experiment with different camos and attachments!',
                                'Share your success with friends (or keep it a secret!)'
                            ]
                        }
                    ]
                }
            ];


            let guideData = {
                phases: []
            };

            let phases = []; // This will be populated from guideData.phases
            let currentPhaseIndex = 0;
            let currentSubStepIndex = 0;
            let totalGuideSteps = 0;
            let completedGuideSteps = 0;

            // Updated Confetti Colors to match the new theme
            const CONFETTI_COLORS = ['#00A6FB', '#22C55E', '#0077B6', '#F97316', '#8A2BE2']; // Light Blue, Success Green, Accent Blue, Warning Orange, Purple

            // --- Utility Functions ---

            // Show a custom message box
            const showMessageBox = (title, message, codeContent = null) => {
                messageBoxTitle.textContent = title;
                messageBoxContent.textContent = message;
                if (codeContent) {
                    codeOutputTextarea.value = codeContent;
                    codeOutputTextarea.classList.remove('hidden');
                    copyCodeBtn.classList.remove('hidden');
                } else {
                    codeOutputTextarea.classList.add('hidden');
                    copyCodeBtn.classList.add('hidden');
                    codeOutputTextarea.value = '';
                }
                customMessageBox.classList.remove('hidden');
            };

            // Close the custom message box
            closeMessageBoxBtn.addEventListener('click', () => {
                customMessageBox.classList.add('hidden');
            });

            // Copy code to clipboard
            copyCodeBtn.addEventListener('click', () => {
                codeOutputTextarea.select();
                document.execCommand('copy');
                showMessageBox('Copied!', 'The code has been copied to your clipboard. You can now paste it into your `Camo.html` file.');
                // Re-hide the code area after copying success message, or adjust to show only "copied"
                setTimeout(() => {
                    customMessageBox.classList.add('hidden');
                }, 1500); // Hide message box after 1.5 seconds
            });


            // Save progress to localStorage
            const saveProgress = () => {
                const progress = {
                    currentPhaseIndex: currentPhaseIndex,
                    currentSubStepIndex: currentSubStepIndex,
                    checkboxStates: {},
                    completedGuideSteps: completedGuideSteps
                };
                document.querySelectorAll('.step-checkbox').forEach(checkbox => {
                    progress.checkboxStates[checkbox.id] = checkbox.checked;
                });
                localStorage.setItem(PROGRESS_STORAGE_KEY, JSON.stringify(progress));
            };

            // Load progress from localStorage
            const loadProgress = () => {
                const savedProgress = localStorage.getItem(PROGRESS_STORAGE_KEY);
                if (savedProgress) {
                    const progress = JSON.parse(savedProgress);
                    currentPhaseIndex = progress.currentPhaseIndex;
                    currentSubStepIndex = progress.currentSubStepIndex;
                    completedGuideSteps = progress.completedGuideSteps || 0; // Ensure it's initialized

                    // Apply checkbox states after content is rendered
                    // This will be called after renderGuideContent and calculateTotalSteps
                    return progress.checkboxStates;
                }
                return null;
            };

            // Calculate total steps (items) in the entire guide from dynamic data
            const calculateTotalSteps = () => {
                let count = 0;
                guideData.phases.forEach(phase => {
                    phase.subSteps.forEach(subStep => {
                        count += subStep.items.length;
                    });
                });
                totalGuideSteps = count;
            };

            // Update overall guide progress bar and text
            const updateOverallProgress = () => {
                completedGuideSteps = Array.from(document.querySelectorAll('.step-checkbox:checked')).length;
                const percentage = totalGuideSteps > 0 ? (completedGuideSteps / totalGuideSteps) * 100 : 0;
                document.getElementById('overallProgressBarFill').style.width = `${percentage}%`;
                document.getElementById('overallProgressText').textContent = `Overall Progress: ${completedGuideSteps}/${totalGuideSteps} steps completed`;
                saveProgress(); // Save progress after updating
            };

            // Update individual phase progress bar and text
            const updatePhaseProgress = (phaseObj) => {
                const phaseCheckboxes = Array.from(document.querySelectorAll(`#phase-${phaseObj.id} .step-checkbox`));
                const completedPhaseSteps = phaseCheckboxes.filter(cb => cb.checked).length;
                const totalPhaseSteps = phaseCheckboxes.length;
                const percentage = totalPhaseSteps > 0 ? (completedPhaseSteps / totalPhaseSteps) * 100 : 0;
                const progressBarFill = document.getElementById(`phase-${phaseObj.id}-ProgressBarFill`);
                const progressText = document.getElementById(`phase-${phaseObj.id}-ProgressText`);

                if (progressBarFill && progressText) {
                    progressBarFill.style.width = `${percentage}%`;
                    progressText.textContent = `Phase Progress: ${completedPhaseSteps}/${totalPhaseSteps} steps completed`;
                }
            };

            // Handle individual checkbox visual update
            const handleCheckboxDisplay = (checkbox) => {
                const listItem = checkbox.closest('.step-item');
                if (listItem) {
                    if (checkbox.checked) {
                        listItem.classList.add('completed');
                    } else {
                        listItem.classList.remove('completed');
                    }
                }
                updateOverallProgress();
                if (phases[currentPhaseIndex]) {
                    updatePhaseProgress(phases[currentPhaseIndex]);
                }
            };

            // Create a confetti particle
            const createConfetti = (x, y) => {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${x}px`;
                confetti.style.top = `${y}px`;
                confetti.style.backgroundColor = CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)];

                const type = Math.random();
                if (type < 0.33) {
                    confetti.classList.add('square');
                } else if (type < 0.66) {
                    confetti.classList.add('triangle');
                } else {
                    // Default is circle
                }

                document.body.appendChild(confetti);

                setTimeout(() => {
                    confetti.remove();
                }, 2000); // Remove after animation
            };

            // Trigger confetti effect
            const launchConfetti = () => {
                const count = 100; // Number of confetti particles
                for (let i = 0; i < count; i++) {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * window.innerHeight;
                    createConfetti(x, y);
                }
            };

            // --- Dynamic Guide Rendering ---
            const renderGuideContent = () => {
                dynamicGuideContent.innerHTML = ''; // Clear existing content
                initialLoadingMessage.style.display = 'none';

                if (guideData.phases.length === 0) {
                    dynamicGuideContent.innerHTML = '<p class="text-center text-text-lighter mt-8">No guide content available. Please use the <a href="editor.html" class="text-light-blue hover:underline">Admin Panel</a> or import JSON to add phases.</p>';
                    return;
                }

                guideData.phases.forEach((phase, phaseIdx) => {
                    const phaseSection = document.createElement('section');
                    phaseSection.id = `phase-${phase.id}`; // Use actual ID for direct access
                    phaseSection.className = 'section-container';

                    phaseSection.innerHTML = `
                        <h2 class="text-3xl sm:text-4xl font-bold text-light-blue mb-6 flex items-center">
                            <span class="mr-3">${phase.title}</span>
                        </h2>
                        <div class="sub-step-progress mb-6">
                            <div class="progress-bar">
                                <div id="phase-${phase.id}-ProgressBarFill" class="progress-fill"></div>
                            </div>
                            <p class="text-right text-sm text-text-lighter" id="phase-${phase.id}-ProgressText"></p>
                        </div>
                        <div id="phase-${phase.id}-StepsContainer">
                            </div>
                        <div class="flex justify-between mt-6">
                            <button id="prevPhase${phaseIdx + 1}SubStep" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105" style="display: none;" data-phase-index="${phaseIdx}">
                                Previous Step
                            </button>
                            <button id="nextPhase${phaseIdx + 1}SubStep" class="bg-accent-blue hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-full shadow-3xl transition duration-300 ease-in-out transform hover:scale-105" data-phase-index="${phaseIdx}">
                                Next Step
                            </button>
                            <button id="completePhase${phaseIdx + 1}" class="bg-success-green hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 hidden" data-phase-index="${phaseIdx}">
                                ${phaseIdx < guideData.phases.length - 1 ? `Complete Phase ${phaseIdx + 1}: Proceed to Next Phase` : `Guide Completed: Camouflage Duplication Mastered`}
                            </button>
                        </div>
                    `;
                    const subStepsContainer = phaseSection.querySelector(`#phase-${phase.id}-StepsContainer`);
                    let subStepCount = 0;
                    phase.subSteps.forEach(subStep => {
                        subStepCount++;
                        const subStepDiv = document.createElement('div');
                        subStepDiv.className = 'sub-step-container bg-secondary-dark/70 p-6 rounded-xl mb-6 border border-accent-blue/10';
                        subStepDiv.dataset.subStepId = subStep.id; // Use actual ID for direct access

                        subStepDiv.innerHTML = `
                            <h3 class="text-2xl font-semibold text-text-light mb-4">${subStep.title}</h3>
                            <ul class="space-y-3">
                                </ul>
                        `;
                        const itemsList = subStepDiv.querySelector('ul');
                        let itemIndex = 0;
                        subStep.items.forEach(item => {
                            itemIndex++;
                            const listItem = document.createElement('li');
                            listItem.className = 'flex items-start text-lg step-item';
                            // Use unique IDs for checkboxes based on phase, sub-step, and item
                            const checkboxId = `cb_${phase.id}_${subStep.id}_${itemIndex}`;
                            listItem.innerHTML = `
                                <input type="checkbox" id="${checkboxId}"
                                       data-phase-id="${phase.id}"
                                       data-sub-step-id="${subStep.id}"
                                       data-item-idx="${itemIndex - 1}"
                                       class="step-checkbox mt-1">
                                <label for="${checkboxId}">${item}</label>
                            `;
                            itemsList.appendChild(listItem);
                        });
                        subStepsContainer.appendChild(subStepDiv);
                    });
                    dynamicGuideContent.appendChild(phaseSection);
                });

                // Re-populate the global `phases` array after dynamic rendering
                phases = guideData.phases.map(p => ({
                    id: `phase-${p.id}`,
                    containerId: `phase-${p.id}-StepsContainer`,
                    subSteps: Array.from(document.querySelectorAll(`#phase-${p.id}-StepsContainer .sub-step-container`))
                }));

                // Attach checkbox listeners
                document.querySelectorAll('.step-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (event) => {
                        handleCheckboxDisplay(event.target);
                    });
                });

                // Attach navigation button listeners
                phases.forEach((phase, index) => {
                    const nextButton = document.getElementById(`nextPhase${index + 1}SubStep`);
                    const prevButton = document.getElementById(`prevPhase${index + 1}SubStep`);
                    const completeButton = document.getElementById(`completePhase${index + 1}`);

                    if (nextButton) {
                        nextButton.addEventListener('click', nextSubStep);
                    }
                    if (prevButton) {
                        prevButton.addEventListener('click', prevSubStep);
                    }
                    if (completeButton) {
                        completeButton.addEventListener('click', () => {
                            if (index < phases.length - 1) {
                                showPhase(index + 1); // Go to next phase
                            } else {
                                // Last phase completed
                                launchConfetti();
                                // Custom alert for completion
                                showMessageBox(
                                    'Guide Completed: Camouflage Duplication Mastered!',
                                    'You have successfully completed the guide. Enjoy your newly customized weapons!'
                                );
                            }
                        });
                    }
                });
            };


            // --- Step Navigation Functions ---

            // Display the current sub-step within the active phase
            const showCurrentSubStep = () => {
                const currentPhase = phases[currentPhaseIndex];
                if (!currentPhase || !currentPhase.subSteps || currentPhase.subSteps.length === 0) {
                    console.warn(`Phase or sub-steps not found for index ${currentPhaseIndex}`);
                    return;
                }

                const subSteps = currentPhase.subSteps;

                subSteps.forEach((subStep, index) => {
                    if (index === currentSubStepIndex) {
                        subStep.classList.add('active');
                    } else {
                        subStep.classList.remove('active');
                    }
                });

                // Update navigation buttons
                const prevButton = document.getElementById(`prevPhase${currentPhaseIndex + 1}SubStep`);
                const nextButton = document.getElementById(`nextPhase${currentPhaseIndex + 1}SubStep`);
                const completePhaseButton = document.getElementById(`completePhase${currentPhaseIndex + 1}`);

                if (prevButton) {
                    prevButton.style.display = currentSubStepIndex === 0 ? 'none' : 'inline-block';
                }
                if (nextButton) {
                    nextButton.style.display = currentSubStepIndex < subSteps.length - 1 ? 'inline-block' : 'none';
                }
                if (completePhaseButton) {
                    completePhaseButton.style.display = currentSubStepIndex === subSteps.length - 1 ? 'inline-block' : 'none';
                }

                updatePhaseProgress(guideData.phases[currentPhaseIndex]); // Use guideData object for consistency
                window.scrollTo({ top: 0, behavior: 'smooth' });
                saveProgress();
            };

            // Navigate to the next sub-step
            const nextSubStep = () => {
                const currentPhase = phases[currentPhaseIndex];
                if (currentSubStepIndex < currentPhase.subSteps.length - 1) {
                    currentSubStepIndex++;
                    showCurrentSubStep();
                }
            };

            // Navigate to the previous sub-step
            const prevSubStep = () => {
                if (currentSubStepIndex > 0) {
                    currentSubStepIndex--;
                    showCurrentSubStep();
                }
            };

            // --- Phase Navigation Functions ---

            // Show a specific phase
            const showPhase = (phaseIndex) => {
                // Hide all phases
                document.querySelectorAll('.section-container').forEach(phaseEl => {
                    phaseEl.classList.remove('active');
                });

                // Show the target phase
                // Ensure phaseIndex is valid
                if (phaseIndex >= 0 && phaseIndex < phases.length) {
                    const targetPhaseEl = document.getElementById(phases[phaseIndex].id);
                    if (targetPhaseEl) {
                        targetPhaseEl.classList.add('active');
                        currentPhaseIndex = phaseIndex;
                        currentSubStepIndex = 0; // Reset sub-step when changing phase
                        showCurrentSubStep(); // Show first sub-step of the new phase
                        updateOverallProgress();
                    }
                } else {
                    // If no phase to show (e.g., after reset), hide all
                    currentPhaseIndex = 0;
                    currentSubStepIndex = 0;
                }
                saveProgress(); // Save progress after showing phase
            };

            // Reset Guide Function
            const resetGuide = () => {
                currentPhaseIndex = 0;
                currentSubStepIndex = 0;
                document.querySelectorAll('.step-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                    handleCheckboxDisplay(checkbox); // Update display and save
                });
                localStorage.removeItem(PROGRESS_STORAGE_KEY); // Clear saved progress
                startButton.style.display = 'block'; // Show start button
                guideContent.classList.add('hidden'); // Hide guide content
                showPhase(''); // Hide all phases (resets currentPhaseIndex/currentSubStepIndex)
                updateOverallProgress(); // Recalculate progress to 0
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            resetButton.addEventListener('click', resetGuide);


            // --- Initial Setup on Load ---

            // Load guide data from admin panel's localStorage or default
            const loadGuideData = () => {
                const storedAdminData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedAdminData) {
                    guideData.phases = JSON.parse(storedAdminData);
                } else if (defaultGuideData.length > 0) {
                    // If no local storage data, use the default data baked into the HTML
                    guideData.phases = defaultGuideData;
                } else {
                    // Custom alert if no content is available, suggesting admin panel
                    showMessageBox(
                        'No Guide Content Available',
                        'Please navigate to the Admin Panel or import JSON here to add phases and steps to the guide.',
                        null // No code content for this message
                    );
                    guideData.phases = []; // Ensure phases array is empty
                }
            };

            // --- Load JSON into Guide (triggered by button) ---
            loadJsonBtnCamo.addEventListener('click', () => {
                const jsonString = jsonInputCamo.value;
                if (!jsonString.trim()) {
                    showMessageBox('No JSON Provided', 'Please paste JSON content into the textarea before loading.');
                    return;
                }

                try {
                    const parsedData = JSON.parse(jsonString);

                    // Basic validation to ensure it's an array of phases with expected structure
                    if (!Array.isArray(parsedData) || !parsedData.every(p => typeof p === 'object' && p.id && p.title && Array.isArray(p.subSteps))) {
                        showMessageBox('Invalid JSON Format', 'The provided JSON does not match the expected guide data structure (array of phases, each with id, title, and subSteps array).');
                        return;
                    }

                    guideData.phases = parsedData; // Overwrite current guideData with the parsed JSON
                    renderGuideContent(); // Re-render the UI with the new data
                    calculateTotalSteps();
                    // Reset progress since we're loading new data
                    currentPhaseIndex = 0;
                    currentSubStepIndex = 0;
                    completedGuideSteps = 0;
                    localStorage.removeItem(PROGRESS_STORAGE_KEY); // Clear old progress
                    updateOverallProgress(); // Update progress bar for new data
                    showPhase(0); // Display the first phase of the newly loaded guide
                    startButton.style.display = 'none'; // Hide start button as guide is now visible
                    guideContent.classList.remove('hidden'); // Show guide content
                    showMessageBox('Guide Loaded!', 'Guide content has been successfully loaded from JSON.');
                    jsonInputCamo.value = ''; // Clear the textarea after successful load
                } catch (error) {
                    console.error("Error parsing JSON:", error);
                    showMessageBox('JSON Error', 'Failed to parse JSON. Please check for syntax errors. Error: ' + error.message);
                }
            });

            // --- Generate HTML with Baked-in JSON (triggered by button) ---
            saveHtmlDefaultBtn.addEventListener('click', () => {
                const currentGuideJson = JSON.stringify(guideData.phases, null, 4); // Pretty print JSON

                // Read the current HTML content of this page dynamically
                // This is a simplified approach; in a real build process, you'd use templating.
                // For this scenario, we'll construct the string to replace the defaultGuideData.
                let currentHtmlContent = document.documentElement.outerHTML;

                // Escape backticks within the JSON string for JavaScript template literals
                const escapedJson = currentGuideJson.replace(/`/g, '\\`');

                // Find the defaultGuideData array declaration and replace its content
                // This is a regex-based replacement, which is fragile but works for this context.
                const regex = /(let defaultGuideData = )\[[^\]]*?\];/s; // The 's' flag for dotall
                if (currentHtmlContent.match(regex)) {
                    currentHtmlContent = currentHtmlContent.replace(regex, `$1\`${escapedJson}\`;`); // Replace with template literal for multi-line JSON
                } else {
                    // Fallback if regex doesn't match exactly (e.g., if array structure changes)
                    // This might need manual adjustment if the defaultGuideData declaration changes significantly.
                    showMessageBox('Error Generating HTML', 'Could not locate `defaultGuideData` in the current HTML. Please ensure its structure is `let defaultGuideData = [...]` for this feature to work.');
                    return;
                }

                showMessageBox(
                    'Updated `Camo.html` Code Generated!',
                    'Copy the code below and paste it into your `Camo.html` file to make the current guide content the default when the page loads.',
                    currentHtmlContent
                );
            });


            loadGuideData(); // Load the content first (from local storage or default)
            renderGuideContent(); // Render the content based on loaded data
            calculateTotalSteps(); // Calculate total steps from rendered content

            const savedCheckboxStates = loadProgress(); // Load user progress after content is rendered

            if (savedCheckboxStates) {
                // Apply checkbox states after the dynamic content has been rendered
                for (const id in savedCheckboxStates) {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.checked = savedCheckboxStates[id];
                        handleCheckboxDisplay(checkbox); // Ensure visual update and recalculate progress
                    }
                }
                // Now that all checkboxes are set and total steps are calculated, update overall progress
                updateOverallProgress();

                // If progress loaded, show the guide content immediately and jump to saved phase/step
                guideContent.classList.remove('hidden');
                startButton.style.display = 'none';
                showPhase(currentPhaseIndex); // This also calls showCurrentSubStep
            } else {
                // No saved progress, start fresh
                startButton.style.display = 'block';
                guideContent.classList.add('hidden');
                updateOverallProgress(); // Initialize progress display for a fresh start
            }

            // Start Button Click
            startButton.addEventListener('click', () => {
                if (guideData.phases.length === 0) {
                     // Custom alert if no content is available
                     showMessageBox(
                         'No Guide Content Available',
                         'Please navigate to the Admin Panel or import JSON here to add phases and steps to the guide.',
                         null // No code content for this message
                     );
                     return; // Prevent starting the guide if no content
                }
                startButton.style.display = 'none'; // Hide start button
                guideContent.classList.remove('hidden'); // Show guide content
                showPhase(0); // Start with Phase 1
            });
        });
    </script>
</body>
</html>
