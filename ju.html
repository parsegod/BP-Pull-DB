<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced JSON Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles for light mode */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the top */
            min-height: 100vh; /* Ensure body takes full viewport height */
            padding: 7px; /* Further reduced padding by ~30% */
            box-sizing: border-box;
            color: #374151; /* Default text color */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 14px; /* Further reduced padding by ~30% */
            width: 100%;
            max-width: 1200px; /* ADJUSTED: Increased max-width for more horizontal space */
            display: grid; /* Using grid for main layout */
            grid-template-columns: 1fr; /* Single column by default on small screens */
            gap: 7px; /* Further reduced gap by ~30% */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        /* Media query for 3 columns on larger screens (this will now wrap the 4th section below) */
        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        @media (min-width: 768px) and (max-width: 1023px) { /* Two columns on medium screens */
            .container {
                grid-template-columns: 1fr 1fr;
            }
            .structured-editor-section,
            .blueprint-images-section { /* Added blueprint images section to span two columns */
                grid-column: span 2;
            }
        }

        textarea {
            width: 100%;
            min-height: 80px; /* ADJUSTED: Reduced min-height to make it more compact */
            height: auto; /* Allow height to adjust based on content */
            max-height: 200px; /* ADJUSTED: Reduced max-height for compactness */
            overflow-y: auto; /* Enable scrolling if content exceeds max-height */
            flex-grow: 1; /* Allow textareas to grow within flex containers */
            padding: 7px; /* Further reduced padding by ~30% */
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: monospace;
            font-size: 10px; /* Further reduced font size */
            resize: vertical;
            transition: border-color 0.2s ease-in-out;
            outline: none;
            background-color: #f9fafb; /* Light background for textareas */
            color: #1f2937; /* Dark text for readability */
            margin-bottom: 7px; /* Adjusted margin-bottom by ~30% */
        }
        textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .section-panel {
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to the top */
            gap: 7px; /* Further reduced gap by ~30% */
            padding: 10px; /* Further reduced padding by ~30% */
            border-radius: 10px;
            background-color: #f9fafb;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 7px; /* ADDED: To reduce space between panels if they are not full */
        }
        .section-panel h2 {
            font-size: 1.2rem; /* Adjusted heading size by ~30% */
            margin-bottom: 7px; /* Adjusted margin for heading by ~30% */
        }

        .button-group {
            display: flex;
            gap: 4px; /* Further reduced gap by ~30% */
            flex-wrap: wrap;
            justify-content: center;
            /* margin-top: auto; -- REMOVED THIS LINE */
        }
        .btn {
            padding: 5px 10px; /* Further reduced padding by ~30% */
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 3px; /* Further reduced gap by ~30% */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 0.7rem; /* Further reduced font size */
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-sm {
            padding: 3px 6px; /* Further reduced padding by ~30% */
            font-size: 0.65rem; /* Further reduced font size */
        }

        .message-box {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 8px; /* Reduced padding by ~30% */
            border-radius: 8px;
            margin-top: 7px; /* Reduced margin by ~30% */
            text-align: center;
            font-weight: 500;
            display: none; /* Hidden by default */
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 0.75rem; /* Reduced font size */
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .file-input-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px; /* Reduced gap by ~30% */
        }
        .file-input-label {
            padding: 6px 12px; /* Reduced padding by ~30% */
            background-color: #10b981;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 0.75rem; /* Reduced font size */
        }
        .file-input-label:hover {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        input[type="file"] {
            display: none;
        }

        /* Structured Editor Specific Styles */
        .structured-editor-section {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 10px; /* Further reduced padding by ~30% */
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 7px; /* Further reduced gap by ~30% */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 7px; /* ADDED: To reduce space between panels if they are not full */
        }
        .structured-editor-section h2, .structured-editor-section h3 {
            margin-bottom: 4px; /* Further reduced margin for headings by ~30% */
            font-size: 1rem; /* Adjusted h3 size by ~30% */
        }
        .blueprint-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px; /* Further reduced padding by ~30% */
            border-bottom: 1px solid #e5e7eb;
            background-color: #ffffff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s ease;
            font-size: 10px; /* Further reduced font size */
        }
        .blueprint-list-item:hover {
            background-color: #f3f4f6;
        }
        .blueprint-list-item:last-child {
            border-bottom: none;
        }
        .blueprint-actions {
            display: flex;
            gap: 2px; /* Further reduced gap by ~30% */
        }
        .form-group {
            margin-bottom: 4px; /* Further reduced margin by ~30% */
        }
        .form-group:last-of-type { /* Adjust margin for the last form group before a button group */
            margin-bottom: 7px; /* Adjusted margin by ~30% */
        }
        .form-group label {
            display: block;
            margin-bottom: 2px; /* Further reduced margin by ~30% */
            font-weight: 500;
            color: #374151;
            font-size: 11px; /* Adjusted label font size */
        }
        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 6px; /* Further reduced padding by ~30% */
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 10px; /* Further reduced font size */
            background-color: #ffffff;
            color: #1f2937;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-group input[type="text"]:focus,
        .form-group select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .hr {
            margin-top: 7px; /* Adjusted margin for the hr by ~30% */
            margin-bottom: 7px;
        }

        /* NEW: Styles for Blueprint Images Section */
        .blueprint-images-section {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 7px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .blueprint-images-section h2 {
            font-size: 1.2rem;
            margin-bottom: 7px;
        }
        .images-list-container { /* Container for weapon folders */
            max-height: 250px; /* Limit overall height of the list */
            overflow-y: auto; /* Enable scrolling for the whole list */
            padding-right: 5px; /* Add some padding for scrollbar */
        }
        .weapon-image-folder { /* Style for each weapon folder */
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            background-color: #f3f4f6;
        }
        .weapon-image-folder h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #4b5563;
        }
        .images-grid { /* Grid for images within each folder */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* Smaller minmax for images */
            gap: 5px; /* Gap between images */
            margin-top: 5px;
        }
        .images-grid img {
            width: 100%;
            height: auto;
            border-radius: 4px;
            object-fit: cover; /* Ensures images cover their space without distortion */
            display: block; /* Remove extra space below images */
        }
        /* Style for "No image." placeholder - now clickable */
        .images-grid .clickable-no-image {
            text-align: center;
            color: #6b7280;
            font-size: 0.75rem;
            padding: 5px;
            border: 1px dashed #d1d5db;
            border-radius: 4px;
            display: flex;
            flex-direction: column; /* To stack "No Image for" and blueprint name */
            align-items: center;
            justify-content: center;
            min-height: 70px; /* Ensure placeholder has a size */
            cursor: pointer; /* Indicate it's clickable */
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .images-grid .clickable-no-image:hover {
            background-color: #e0e0e0; /* Light hover effect */
            transform: translateY(-1px);
        }

        .images-grid p { /* Fallback for no images in folder */
            text-align: center;
            color: #6b7280;
            font-size: 0.85rem;
            padding: 5px;
            grid-column: span / all; /* Span across all columns in grid */
        }


        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        body.dark-mode .container {
            background-color: #2d3748;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        body.dark-mode textarea {
            background-color: #242c37;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark-mode textarea:focus {
            border-color: #63b3ed;
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.2);
        }
        body.dark-mode .section-panel,
        body.dark-mode .structured-editor-section,
        body.dark-mode .blueprint-images-section { /* Added new section to dark mode */
            background-color: #2d3748;
            border-color: #4a5568;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .form-group label {
            color: #cbd5e0;
        }
        body.dark-mode .form-group input[type="text"],
        body.dark-mode .form-group select {
            background-color: #242c37;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark-mode .form-group input[type="text"]:focus,
        body.dark-mode .form-group select:focus {
            border-color: #63b3ed;
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.2);
        }
        body.dark-mode .blueprint-list-item {
            background-color: #364254;
            border-color: #4a5568;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .blueprint-list-item:hover {
            background-color: #3f4c60;
        }
        body.dark-mode .message-box {
            background-color: #2a4365;
            color: #90cdf4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        body.dark-mode .message-box.error {
            background-color: #742a2a;
            color: #f56565;
        }
        body.dark-mode .message-box.success {
            background-color: #2f855a;
            color: #9ae6b4;
        }
        body.dark-mode .images-grid { /* Dark mode for images grid */
            background-color: #242c37;
            border-color: #4a5568;
        }
        body.dark-mode .images-grid p {
            color: #a0aec0;
        }
        body.dark-mode .weapon-image-folder {
            background-color: #364254;
            border-color: #4a5568;
        }
        body.dark-mode .weapon-image-folder h4 {
            color: #cbd5e0;
        }
        body.dark-mode .images-grid .clickable-no-image:hover {
            background-color: #4f5b6e; /* Dark mode hover effect */
        }


        .dark-mode-toggle {
            position: absolute;
            top: 7px; /* Adjusted position by ~30% */
            right: 7px; /* Adjusted position by ~30% */
            background-color: #60a5fa;
            color: white;
            padding: 4px 8px; /* Further reduced padding by ~30% */
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 3px; /* Further reduced gap by ~30% */
            font-size: 0.7rem; /* Further reduced font size */
        }
        .dark-mode-toggle:hover {
            background-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <button id="darkModeToggle" class="dark-mode-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
        </svg>
        Toggle Dark Mode
    </button>

    <div class="container">
        <div class="section-panel">
            <h2 class="text-2xl font-bold text-center mb-4">JSON Input</h2>
            <textarea id="jsonInput" placeholder="Loading JSON or paste your JSON here..."></textarea>
            <div class="button-group">
                <label for="fileInput" class="file-input-label">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.414L14.586 5A2 2 0 0115 6.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    Load JSON File
                </label>
                <input type="file" id="fileInput" accept=".json">
                <button id="clearInput" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 3a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd" />
                    </svg>
                    Clear Input
                </button>
            </div>
        </div>

        <div class="section-panel">
            <h2 class="text-2xl font-bold text-center mb-4">JSON Output</h2>
            <textarea id="jsonOutput" readonly></textarea>
            <div class="button-group">
                <button id="copyOutput" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                    </svg>
                    Copy Output
                </button>
                <button id="downloadJson" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download JSON
                </button>
                <button id="clearOutput" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 3a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd" />
                    </svg>
                    Clear Output
                </button>
            </div>
        </div>

        <div class="structured-editor-section">
            <h2 class="text-2xl font-bold text-center mb-4">Structured Editor</h2>

            <h3 class="text-xl font-semibold mb-2">Manage Weapons:</h3>
            <div class="form-group">
                <label for="weaponSelect">Select Weapon:</label>
                <select id="weaponSelect" class="block w-full mt-1"></select>
            </div>
            <div class="form-group">
                <label for="weaponName">Weapon Name:</label>
                <input type="text" id="weaponName" placeholder="Enter weapon name" class="w-full">
            </div>
            <div class="form-group">
                <label for="weaponCategory">Category:</label>
                <input type="text" id="weaponCategory" placeholder="Enter category (e.g., '0')" class="w-full">
            </div>
            <div class="button-group">
                <button id="addWeaponBtn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add Weapon
                </button>
                <button id="saveWeaponBtn" class="btn btn-primary" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Save Weapon
                </button>
                <button id="deleteWeaponBtn" class="btn btn-danger" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 3a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd" />
                    </svg>
                    Delete Weapon
                </button>
                <button id="cancelWeaponEditBtn" class="btn btn-secondary" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Cancel
                </button>
            </div>

            <hr class="my-4 border-gray-300 dark:border-gray-600 hr">

            <h3 class="text-xl font-semibold mb-2">Manage Blueprints:</h3>
            <div id="blueprintsList" class="mb-4 border rounded-md max-h-64 overflow-y-auto">
                </div>

            <h3 class="text-xl font-semibold mb-2">Add/Edit Blueprint:</h3>
            <div class="form-group">
                <label for="blueprintName">Blueprint Name:</label>
                <input type="text" id="blueprintName" placeholder="Enter blueprint name" class="w-full">
            </div>
            <div class="form-group">
                <label for="blueprintPool">Pool:</label>
                <input type="text" id="blueprintPool" placeholder="Enter pool number" class="w-full">
            </div>
            <div class="button-group">
                <button id="addBlueprintBtn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add Blueprint
                </button>
                <button id="saveBlueprintBtn" class="btn btn-primary" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Save Changes
                </button>
                <button id="cancelBlueprintEditBtn" class="btn btn-secondary" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Cancel
                </button>
            </div>
        </div>

        <div class="blueprint-images-section">
            <h2 class="text-2xl font-bold text-center mb-4">Blueprint Images</h2>
            <div id="imagesListContainer" class="images-list-container">
                <p>Loading images...</p>
            </div>
            <div class="button-group">
                <button id="refreshImagesBtn" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.586a1 1 0 01.293.707l-.707.707a1 1 0 01-1.414 0l-1-1a1 1 0 010-1.414L3 3a1 1 0 011-1zm12 0a1 1 0 011 1v2.586a1 1 0 01-.293.707l.707.707a1 1 0 011.414 0l1-1a1 1 0 010-1.414L17 3a1 1 0 01-1-1zM2 10a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1zM5 16a1 1 0 01-1-1v-2.586a1 1 0 01-.293-.707l.707-.707a1 1 0 011.414 0l1 1a1 1 0 010 1.414L5 16zm12 0a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l-.707-.707a1 1 0 01-1.414 0l-1 1a1 1 0 010 1.414L17 16z" clip-rule="evenodd" />
                    </svg>
                    Refresh Images
                </button>
            </div>

            <hr class="my-4 border-gray-300 dark:border-gray-600 hr">

            <h3 class="text-xl font-semibold mb-2">Upload Missing Image:</h3>
            <p class="text-gray-600 mb-4 text-sm">
                Upload an image file for a specific blueprint. Ensure the Weapon Name and Blueprint Name match your data, and the file is an image (JPG, PNG, GIF).
            </p>
            <div class="form-group">
                <label for="imageUploadWeaponSelect">Select Weapon for Upload:</label>
                <select id="imageUploadWeaponSelect" class="block w-full mt-1"></select>
            </div>
            <div class="form-group">
                <label for="imageUploadBlueprintName">Blueprint Name (for image):</label>
                <input type="text" id="imageUploadBlueprintName" placeholder="Enter blueprint name matching the image" class="w-full">
            </div>
            <div class="file-input-wrapper">
                <label for="imageFileInput" class="file-input-label">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l.686-.273a1 1 0 00.342-1.174L6.01 9.75a1 1 0 00-.792-.792L.82 8.322A1 1 0 00.25 10.518l1.49 2.982A1 1 0 003 14h14a1 1 0 00.894-1.447l-7-14z" />
                    </svg>
                    Select Image File
                </label>
                <input type="file" id="imageFileInput" accept=".jpg,.jpeg,.png,.gif">
                <span id="imageFileName" class="text-gray-500 text-sm italic">No file chosen</span>
            </div>
            <div class="button-group mt-3">
                <button id="uploadImageBtn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                    </svg>
                    Upload Image
                </button>
            </div>
        </div>
    </div>

    <div id="messageBox" class="message-box fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-sm transition-all duration-300 ease-in-out">
        <span id="messageText"></span>
    </div>

    <script>
        const jsonInput = document.getElementById('jsonInput');
        const jsonOutput = document.getElementById('jsonOutput');
        const clearInputBtn = document.getElementById('clearInput');
        const copyOutputBtn = document.getElementById('copyOutput');
        const downloadJsonBtn = document.getElementById('downloadJson');
        const clearOutputBtn = document.getElementById('clearOutput');
        const fileInput = document.getElementById('fileInput');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const darkModeToggle = document.getElementById('darkModeToggle');

        // Structured Editor Elements - Weapon Management
        const weaponSelect = document.getElementById('weaponSelect');
        const weaponNameInput = document.getElementById('weaponName');
        const weaponCategoryInput = document.getElementById('weaponCategory');
        const addWeaponBtn = document.getElementById('addWeaponBtn');
        const saveWeaponBtn = document.getElementById('saveWeaponBtn');
        const deleteWeaponBtn = document.getElementById('deleteWeaponBtn');
        const cancelWeaponEditBtn = document.getElementById('cancelWeaponEditBtn');

        // Structured Editor Elements - Blueprint Management
        const blueprintsList = document.getElementById('blueprintsList');
        const blueprintNameInput = document.getElementById('blueprintName');
        const blueprintPoolInput = document.getElementById('blueprintPool');
        const addBlueprintBtn = document.getElementById('addBlueprintBtn');
        const saveBlueprintBtn = document.getElementById('saveBlueprintBtn');
        const cancelBlueprintEditBtn = document.getElementById('cancelBlueprintEditBtn');

        // NEW: Blueprint Images Elements
        const imagesListContainer = document.getElementById('imagesListContainer');
        const refreshImagesBtn = document.getElementById('refreshImagesBtn');
        const imageUploadWeaponSelect = document.getElementById('imageUploadWeaponSelect');
        const imageUploadBlueprintNameInput = document.getElementById('imageUploadBlueprintName'); // This was missing in your provided HTML
        const imageFileInput = document.getElementById('imageFileInput');
        const imageFileNameSpan = document.getElementById('imageFileName');
        const uploadImageBtn = document.getElementById('uploadImageBtn');

        let jsonData = null; // Global variable to hold the parsed JSON data
        let currentWeaponIndex = -1; // Index of the currently selected weapon
        let editingBlueprintIndex = -1; // Index of the blueprint being edited (-1 if not editing)
        let editingWeaponMode = false; // True if editing an existing weapon

        /**
         * Displays a temporary message in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success' or 'error' or 'info').
         */
        function showMessage(message, type) {
            messageText.textContent = message;
            messageBox.className = `message-box fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-sm transition-all duration-300 ease-in-out ${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Updates the main JSON data and refreshes the input/output textareas.
         * This function now ensures both input and output are formatted.
         */
        function updateJsonDisplay() {
            if (jsonData) {
                const formattedJson = JSON.stringify(jsonData, null, 2);
                jsonInput.value = formattedJson; // Input is now also formatted when updated from data model
                jsonOutput.value = formattedJson;
            } else {
                jsonInput.value = '';
                jsonOutput.value = '';
            }
            populateImageUploadWeaponSelect(); // Ensure image upload dropdown is updated
        }

        /**
         * Populates the weapon selection dropdown.
         */
        function populateWeaponSelect() {
            weaponSelect.innerHTML = '<option value="-1">-- Select a Weapon --</option>';
            if (jsonData && jsonData.Weapons) {
                jsonData.Weapons.forEach((weapon, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = weapon.Name;
                    weaponSelect.appendChild(option);
                });
            }
            // Attempt to re-select the current weapon if it still exists
            if (currentWeaponIndex !== -1 && jsonData && jsonData.Weapons[currentWeaponIndex]) {
                weaponSelect.value = currentWeaponIndex;
            } else {
                currentWeaponIndex = -1; // Reset if weapon no longer exists
                weaponSelect.value = -1;
            }
            renderBlueprints(); // Re-render blueprints based on new selection
            clearBlueprintForm(); // Clear blueprint form
            clearWeaponForm(); // Clear weapon form
        }

        /**
         * Renders the blueprints for the currently selected weapon.
         */
        function renderBlueprints() {
            blueprintsList.innerHTML = ''; // Clear existing list
            if (currentWeaponIndex !== -1 && jsonData && jsonData.Weapons[currentWeaponIndex]) {
                const blueprints = jsonData.Weapons[currentWeaponIndex].Blueprints;
                if (blueprints.length === 0) {
                    blueprintsList.innerHTML = '<p class="p-4 text-gray-500 text-center">No blueprints for this weapon.</p>';
                    return;
                }
                blueprints.forEach((blueprint, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'blueprint-list-item';
                    listItem.innerHTML = `
                        <span><strong>Name:</strong> ${blueprint.Name}, <strong>Pool:</strong> ${blueprint.Pool}</span>
                        <div class="blueprint-actions">
                            <button class="btn btn-primary btn-sm edit-blueprint-btn" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-7.65 7.65a1 1 0 01-.325.247l-4 1a1 1 0 01-1.266-1.266l1-4a1 1 0 01.247-.325l7.65-7.65zM10 11a2 2 0 100 4 2 2 0 000-4z" />
                                </svg>
                                Edit
                            </button>
                            <button class="btn btn-danger btn-sm delete-blueprint-btn" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 3a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd" />
                                </svg>
                                Delete
                            </button>
                        </div>
                    `;
                    blueprintsList.appendChild(listItem);
                });

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-blueprint-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const index = parseInt(event.currentTarget.dataset.index);
                        editBlueprint(index);
                    });
                });
                document.querySelectorAll('.delete-blueprint-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const index = parseInt(event.currentTarget.dataset.index);
                        deleteBlueprint(index);
                    });
                });
            }
        }

        /**
         * Clears the blueprint form input fields and resets editing state.
         */
        function clearBlueprintForm() {
            blueprintNameInput.value = '';
            blueprintPoolInput.value = '';
            editingBlueprintIndex = -1;
            addBlueprintBtn.style.display = 'inline-flex';
            saveBlueprintBtn.style.display = 'none';
            cancelBlueprintEditBtn.style.display = 'none';
        }

        /**
         * Populates the form with blueprint data for editing.
         * @param {number} index - The index of the blueprint to edit.
         */
        function editBlueprint(index) {
            if (currentWeaponIndex === -1 || !jsonData || !jsonData.Weapons[currentWeaponIndex]) {
                showMessage('No weapon selected or data not loaded.', 'error');
                return;
            }
            const blueprint = jsonData.Weapons[currentWeaponIndex].Blueprints[index];
            if (blueprint) {
                blueprintNameInput.value = blueprint.Name;
                blueprintPoolInput.value = blueprint.Pool;
                editingBlueprintIndex = index;
                addBlueprintBtn.style.display = 'none';
                saveBlueprintBtn.style.display = 'inline-flex';
                cancelBlueprintEditBtn.style.display = 'inline-flex';
                showMessage('Editing blueprint...', 'info');
            } else {
                showMessage('Blueprint not found.', 'error');
            }
        }

        /**
         * Deletes a blueprint from the selected weapon.
         * @param {number} index - The index of the blueprint to delete.
         */
        function deleteBlueprint(index) {
            if (currentWeaponIndex === -1 || !jsonData || !jsonData.Weapons[currentWeaponIndex]) {
                showMessage('No weapon selected or data not loaded.', 'error');
                return;
            }
            // Using a custom message box instead of confirm()
            showConfirmation('Are you sure you want to delete this blueprint?', () => {
                jsonData.Weapons[currentWeaponIndex].Blueprints.splice(index, 1);
                updateJsonDisplay();
                renderBlueprints();
                clearBlueprintForm(); // Clear form if current blueprint was being edited
                showMessage('Blueprint deleted successfully!', 'success');
            });
        }

        /**
         * Clears the weapon form input fields and resets editing state.
         */
        function clearWeaponForm() {
            weaponNameInput.value = '';
            weaponCategoryInput.value = '';
            editingWeaponMode = false;
            addWeaponBtn.style.display = 'inline-flex';
            saveWeaponBtn.style.display = 'none';
            deleteWeaponBtn.style.display = 'none';
            cancelWeaponEditBtn.style.display = 'none';
        }

        /**
         * Populates the weapon form for editing.
         */
        function editWeapon() {
            if (currentWeaponIndex === -1 || !jsonData || !jsonData.Weapons[currentWeaponIndex]) {
                showMessage('No weapon selected for editing.', 'error');
                return;
            }
            const weapon = jsonData.Weapons[currentWeaponIndex];
            weaponNameInput.value = weapon.Name;
            weaponCategoryInput.value = weapon.Category;
            editingWeaponMode = true;
            addWeaponBtn.style.display = 'none';
            saveWeaponBtn.style.display = 'inline-flex';
            deleteWeaponBtn.style.display = 'inline-flex';
            cancelWeaponEditBtn.style.display = 'inline-flex';
            showMessage('Editing weapon details...', 'info');
        }


        // --- Event Listener for Raw JSON Input Area ---
        // This listener now only attempts to parse and update the data model and output
        // when the user types. It does NOT auto-format the input textarea.
        jsonInput.addEventListener('input', () => { // Changed from 'change' to 'input' for live validation
            try {
                const parsedJson = JSON.parse(jsonInput.value);
                jsonData = parsedJson; // Update global data
                jsonOutput.value = JSON.stringify(jsonData, null, 2); // Always format output
                populateWeaponSelect(); // Refresh structured editor
                showMessage('JSON input parsed and updated.', 'success');
            } catch (error) {
                // If JSON is invalid, clear output and show error, but keep input as typed
                jsonOutput.value = '';
                showMessage(`Invalid JSON: ${error.message}`, 'error');
                console.error('JSON parsing error:', error);
            }
        });


        clearInputBtn.addEventListener('click', () => {
            jsonInput.value = '';
            jsonOutput.value = '';
            jsonData = null; // Clear global data
            currentWeaponIndex = -1;
            editingBlueprintIndex = -1;
            populateWeaponSelect();
            renderBlueprints();
            clearBlueprintForm();
            clearWeaponForm();
            showMessage('Input cleared.', 'info');
        });

        copyOutputBtn.addEventListener('click', () => {
            if (jsonOutput.value) {
                try {
                    // Using document.execCommand for clipboard copy as navigator.clipboard.writeText
                    // might have restrictions in some iframe environments.
                    jsonOutput.select();
                    document.execCommand('copy');
                    showMessage('Output copied to clipboard!', 'success');
                } catch (err) {
                    showMessage('Failed to copy output. Please copy manually.', 'error');
                    console.error('Copy failed:', err);
                }
            } else {
                showMessage('Nothing to copy.', 'info');
            }
        });

        downloadJsonBtn.addEventListener('click', () => {
            if (jsonOutput.value) {
                const filename = 'data.json';
                const blob = new Blob([jsonOutput.value], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href); // Clean up
                showMessage('JSON downloaded successfully!', 'success');
            } else {
                showMessage('Nothing to download.', 'info');
            }
        });

        clearOutputBtn.addEventListener('click', () => {
            jsonOutput.value = '';
            showMessage('Output cleared.', 'info');
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const fileContent = e.target.result;
                        const parsedJson = JSON.parse(fileContent);
                        jsonData = parsedJson; // Update global data
                        updateJsonDisplay(); // Format and display loaded JSON in both areas
                        populateWeaponSelect(); // Refresh structured editor
                        showMessage(`File "${file.name}" loaded successfully!`, 'success');
                    } catch (error) {
                        jsonInput.value = ''; // Clear input if invalid JSON
                        jsonOutput.value = ''; // Clear output if invalid JSON
                        showMessage(`Error loading file: Invalid JSON in "${file.name}".`, 'error');
                        console.error('Error parsing file JSON:', error);
                    }
                };
                reader.onerror = () => {
                    showMessage('Error reading file.', 'error');
                };
                reader.readAsText(file);
            }
        });

        // --- Event Listeners for Structured Editor - Weapon Management ---
        weaponSelect.addEventListener('change', (event) => {
            currentWeaponIndex = parseInt(event.target.value);
            if (currentWeaponIndex !== -1) {
                editWeapon(); // Populate form for editing selected weapon
                showMessage(`Weapon "${weaponSelect.options[weaponSelect.selectedIndex].text}" selected.`, 'info');
            } else {
                clearWeaponForm();
                showMessage('Select a weapon to manage blueprints or add a new one.', 'info');
            }
            renderBlueprints(); // Always re-render blueprints for the selected weapon
            clearBlueprintForm(); // Clear blueprint form when weapon selection changes
        });

        addWeaponBtn.addEventListener('click', () => {
            const name = weaponNameInput.value.trim();
            const category = weaponCategoryInput.value.trim();

            if (!name || !category) {
                showMessage('Weapon Name and Category cannot be empty.', 'error');
                return;
            }

            if (!jsonData) {
                jsonData = { "Weapons": [] };
            }
            if (!jsonData.Weapons) {
                jsonData.Weapons = [];
            }

            const newWeapon = { Name: name, Category: category, Blueprints: [] };
            jsonData.Weapons.push(newWeapon);
            currentWeaponIndex = jsonData.Weapons.length - 1; // Select the newly added weapon

            updateJsonDisplay();
            populateWeaponSelect();
            showMessage('Weapon added successfully!', 'success');
        });

        saveWeaponBtn.addEventListener('click', () => {
            if (currentWeaponIndex === -1 || !jsonData || !jsonData.Weapons[currentWeaponIndex]) {
                showMessage('No weapon selected for saving.', 'error');
                return;
            }

            const name = weaponNameInput.value.trim();
            const category = weaponCategoryInput.value.trim();

            if (!name || !category) {
                showMessage('Weapon Name and Category cannot be empty.', 'error');
                return;
            }

            jsonData.Weapons[currentWeaponIndex].Name = name;
            jsonData.Weapons[currentWeaponIndex].Category = category;

            updateJsonDisplay();
            populateWeaponSelect(); // Re-populate to update the dropdown text
            showMessage('Weapon updated successfully!', 'success');
        });

        deleteWeaponBtn.addEventListener('click', () => {
            if (currentWeaponIndex === -1 || !jsonData || !jsonData.Weapons[currentWeaponIndex]) {
                showMessage('No weapon selected for deletion.', 'error');
                return;
            }
            // Using a custom message box instead of confirm()
            showConfirmation('Are you sure you want to delete this weapon and all its blueprints?', () => {
                jsonData.Weapons.splice(currentWeaponIndex, 1);
                currentWeaponIndex = -1; // Reset selection
                updateJsonDisplay();
                populateWeaponSelect();
                showMessage('Weapon deleted successfully!', 'success');
            });
        });

        cancelWeaponEditBtn.addEventListener('click', () => {
            clearWeaponForm();
            // If a weapon was selected, re-populate the form with its original data
            if (currentWeaponIndex !== -1 && jsonData && jsonData.Weapons[currentWeaponIndex]) {
                const weapon = jsonData.Weapons[currentWeaponIndex];
                weaponNameInput.value = weapon.Name;
                weaponCategoryInput.value = weapon.Category;
                addWeaponBtn.style.display = 'none';
                saveWeaponBtn.style.display = 'inline-flex';
                deleteWeaponBtn.style.display = 'inline-flex';
                cancelWeaponEditBtn.style.display = 'inline-flex';
            }
            showMessage('Weapon edit cancelled.', 'info');
        });


        // --- Event Listeners for Structured Editor - Blueprint Management ---
        addBlueprintBtn.addEventListener('click', () => {
            if (currentWeaponIndex === -1) {
                showMessage('Please select a weapon first to add blueprints.', 'error');
                return;
            }

            const name = blueprintNameInput.value.trim();
            const pool = blueprintPoolInput.value.trim();

            if (!name || !pool) {
                showMessage('Blueprint Name and Pool cannot be empty.', 'error');
                return;
            }

            const newBlueprint = { Name: name, Pool: String(pool) }; // Ensure Pool is string

            if (!jsonData.Weapons[currentWeaponIndex].Blueprints) {
                jsonData.Weapons[currentWeaponIndex].Blueprints = [];
            }
            jsonData.Weapons[currentWeaponIndex].Blueprints.push(newBlueprint);
            updateJsonDisplay(); // Update and format both text areas
            renderBlueprints();
            clearBlueprintForm();
            showMessage('Blueprint added successfully!', 'success');
        });

        saveBlueprintBtn.addEventListener('click', () => {
            if (currentWeaponIndex === -1 || editingBlueprintIndex === -1) {
                showMessage('No blueprint selected for editing.', 'error');
                return;
            }

            const name = blueprintNameInput.value.trim();
            const pool = blueprintPoolInput.value.trim();

            if (!name || !pool) {
                showMessage('Blueprint Name and Pool cannot be empty.', 'error');
                return;
            }

            jsonData.Weapons[currentWeaponIndex].Blueprints[editingBlueprintIndex].Name = name;
            jsonData.Weapons[currentWeaponIndex].Blueprints[editingBlueprintIndex].Pool = String(pool); // Ensure Pool is string

            updateJsonDisplay(); // Update and format both text areas
            renderBlueprints();
            clearBlueprintForm();
            showMessage('Blueprint updated successfully!', 'success');
        });

        cancelBlueprintEditBtn.addEventListener('click', () => {
            clearBlueprintForm();
            showMessage('Blueprint edit cancelled.', 'info');
        });

        // --- Dark Mode Toggle ---
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            // Store user preference
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        // Apply saved theme on load
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        /**
         * Custom confirmation dialog function.
         * @param {string} message - The message to display in the confirmation.
         * @param {function} onConfirm - Callback function to execute if confirmed.
         */
        function showConfirmation(message, onConfirm) {
            const confirmationBox = document.createElement('div');
            confirmationBox.id = 'customConfirmation';
            confirmationBox.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50';
            confirmationBox.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm text-center">
                    <p class="text-lg font-semibold mb-6 text-gray-800 dark:text-gray-200">${message}</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirmYes" class="btn btn-danger">Yes</button>
                        <button id="confirmNo" class="btn btn-secondary">No</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmationBox);

            document.getElementById('confirmYes').addEventListener('click', () => {
                onConfirm();
                document.body.removeChild(confirmationBox);
            });

            document.getElementById('confirmNo').addEventListener('click', () => {
                document.body.removeChild(confirmationBox);
            });
        }

        // Function to populate the weapon select dropdown for image upload
        function populateImageUploadWeaponSelect() {
            imageUploadWeaponSelect.innerHTML = '<option value="">-- Select Weapon --</option>';
            if (jsonData && jsonData.Weapons) {
                jsonData.Weapons.forEach(weapon => {
                    const option = document.createElement('option');
                    option.value = weapon.Name;
                    option.textContent = weapon.Name;
                    imageUploadWeaponSelect.appendChild(option);
                });
            }
        }

        // NEW: Function to load and display blueprint images based on weapon.json
        function loadBlueprintImages() {
            imagesListContainer.innerHTML = ''; // Clear previous content

            if (!jsonData || !jsonData.Weapons || jsonData.Weapons.length === 0) {
                imagesListContainer.innerHTML = '<p class="p-4 text-gray-500 text-center">No weapon data loaded to display images.</p>';
                return;
            }

            // Path relative to your ju.html file for images
            // This path should match where Vercel serves your static assets from the 'public' folder
            const basePath = '/assets/blueprints/images/'; // Leading slash for absolute path from root

            jsonData.Weapons.forEach(weapon => {
                if (weapon.Blueprints && weapon.Blueprints.length > 0) {
                    const weaponFolderDiv = document.createElement('div');
                    weaponFolderDiv.className = 'weapon-image-folder';

                    const folderNameHeading = document.createElement('h4');
                    folderNameHeading.textContent = weapon.Name;
                    weaponFolderDiv.appendChild(folderNameHeading);

                    const imagesGridDiv = document.createElement('div');
                    imagesGridDiv.className = 'images-grid';

                    let imagesFoundInFolder = false;

                    weapon.Blueprints.forEach(blueprint => {
                        // Skip "NOTHING" or "UNRELEASED" blueprints for image display
                        if (blueprint.Name === "NOTHING" || blueprint.Name === "UNRELEASED" || blueprint.Name === "") {
                            return;
                        }

                        // Use the blueprint name in ALL CAPS for the image path
                        const formattedBlueprintName = blueprint.Name.toUpperCase();
                        // Construct the image URL using encodeURIComponent for safe URL paths
                        const imgPath = `${basePath}${encodeURIComponent(weapon.Name)}/${encodeURIComponent(formattedBlueprintName)}.jpg`;
                        
                        const imgContainer = document.createElement('div'); // Container for image/placeholder and name
                        imgContainer.className = 'flex flex-col items-center justify-center text-center text-xs text-gray-600 dark:text-gray-300';

                        const img = document.createElement('img');
                        img.src = imgPath;
                        img.alt = blueprint.Name;
                        img.title = `${weapon.Name}: ${blueprint.Name}`; // Show full name on hover
                        img.className = 'w-full h-auto rounded-md object-cover border border-gray-200 dark:border-gray-600';

                        // Handle image loading errors (image not found at path)
                        img.onerror = function() {
                            const placeholder = document.createElement('div');
                            // Add new classes for styling and targeting: 'clickable-no-image' and 'cursor-pointer'
                            // Also add hover effect for better user feedback
                            placeholder.className = 'clickable-no-image cursor-pointer w-full h-24 bg-gray-100 dark:bg-gray-600 flex flex-col items-center justify-center rounded-md border border-dashed border-gray-300 dark:border-gray-500 text-gray-500 dark:text-gray-400 text-xs p-1 hover:bg-gray-200 dark:hover:bg-gray-500 transition duration-150';
                            placeholder.innerHTML = `<span class="text-center">No Image for</span><span class="font-semibold text-center mt-1">${blueprint.Name}</span>`; // Display blueprint name clearly
                            // Add data attributes to store weapon and blueprint names
                            placeholder.dataset.weaponName = weapon.Name;
                            placeholder.dataset.blueprintName = blueprint.Name;
                            imgContainer.appendChild(placeholder); // Append placeholder to imgContainer
                            this.remove(); // Remove the broken image element
                        };
                        imgContainer.appendChild(img); // Append image to its container

                        const imgName = document.createElement('span');
                        imgName.className = 'mt-1 truncate w-full';
                        imgName.textContent = blueprint.Name;
                        imgContainer.appendChild(imgName);

                        imagesGridDiv.appendChild(imgContainer); // Append the whole container to the grid
                        imagesFoundInFolder = true;
                    });

                    if (imagesFoundInFolder) {
                        weaponFolderDiv.appendChild(imagesGridDiv);
                        imagesListContainer.appendChild(weaponFolderDiv);
                    } else {
                        // If no valid blueprints with images were found in this weapon folder
                        const noImagesMessage = document.createElement('p');
                        noImagesMessage.textContent = `No displayable blueprints found for ${weapon.Name}.`;
                        weaponFolderDiv.appendChild(noImagesMessage);
                        imagesListContainer.appendChild(weaponFolderDiv);
                    }
                } else {
                    // If the weapon has no blueprints
                    const weaponFolderDiv = document.createElement('div');
                    weaponFolderDiv.className = 'weapon-image-folder';
                    const folderNameHeading = document.createElement('h4');
                    folderNameHeading.textContent = weapon.Name;
                    weaponFolderDiv.appendChild(folderNameHeading);
                    const noBlueprintsMessage = document.createElement('p');
                    noBlueprintsMessage.textContent = `No blueprints defined for ${weapon.Name}.`;
                    weaponFolderDiv.appendChild(noBlueprintsMessage);
                    imagesListContainer.appendChild(weaponFolderDiv);
                }
            });

            if (imagesListContainer.children.length === 0) {
                 imagesListContainer.innerHTML = '<p class="p-4 text-gray-500 text-center">No weapon data with displayable blueprints found.</p>';
            }

            showMessage('Blueprint images displayed based on weapon data.', 'info');
        }

        // NEW: Function to set up click listeners for "No Image" placeholders
        function setupClickablePlaceholders() {
            const placeholders = document.querySelectorAll('.clickable-no-image');
            console.log('Attempting to set up clickable placeholders. Found:', placeholders.length, 'elements.'); // Debugging line
            placeholders.forEach(placeholder => {
                placeholder.addEventListener('click', (event) => {
                    console.log('Placeholder clicked!', event.currentTarget.dataset); // Debugging line
                    const weaponName = event.currentTarget.dataset.weaponName;
                    const blueprintName = event.currentTarget.dataset.blueprintName;

                    // Pre-fill the upload form fields
                    imageUploadWeaponSelect.value = weaponName;
                    imageUploadBlueprintNameInput.value = blueprintName;
                    imageFileInput.value = ''; // Clear any previously selected file
                    imageFileNameSpan.textContent = 'No file chosen'; // Reset file name display

                    // Scroll to the upload section for user convenience
                    imageUploadBlueprintNameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    showMessage(`Upload fields pre-filled for "${blueprintName}" (${weaponName}).`, 'info');
                });
            });
        }

        // NEW: Event listener for the file input to display selected file name
        imageFileInput.addEventListener('change', (event) => {
            const fileName = event.target.files[0] ? event.target.files[0].name : 'No file chosen';
            imageFileNameSpan.textContent = fileName;
        });

        // NEW: Event listener for the Upload Image button
        uploadImageBtn.addEventListener('click', async () => {
            const selectedWeaponName = imageUploadWeaponSelect.value;
            let blueprintName = imageUploadBlueprintNameInput.value.trim(); // Use 'let' because we'll modify it
            const imageFile = imageFileInput.files[0];

            if (!selectedWeaponName || !blueprintName || !imageFile) {
                showMessage('Please select a weapon, enter a blueprint name, and choose an image file.', 'error');
                return;
            }

            // Convert blueprintName to ALL CAPS for the filename
            blueprintName = blueprintName.toUpperCase();

            // Create FormData object to send file and other data
            const formData = new FormData();
            formData.append('weaponName', selectedWeaponName);
            formData.append('blueprintName', blueprintName); // This will now be in ALL CAPS
            formData.append('blueprintImage', imageFile); // 'blueprintImage' must match the name in upload.single() on server

            try {
                // Send the file to your Node.js serverless function on Vercel
                const response = await fetch('/api/upload-blueprint-image', { 
                    method: 'POST',
                    body: formData, // FormData handles setting the correct 'Content-Type' header
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showMessage(`Image for "${blueprintName}" uploaded successfully!`, 'success');
                    // After successful upload, refresh the image list and clear the form
                    loadBlueprintImages();
                    setupClickablePlaceholders(); // Re-apply listeners after images are reloaded
                    imageUploadBlueprintNameInput.value = '';
                    imageFileInput.value = ''; // Clear the file input
                    imageFileNameSpan.textContent = 'No file chosen'; // Reset file name display
                } else {
                    showMessage(`Upload failed: ${result.message || 'Server error'}`, 'error');
                }
            } catch (error) {
                showMessage(`Network error or server unavailable: ${error.message}`, 'error');
                console.error('Upload error:', error);
            }
        });


        /**
         * Initial load of weapon.json and blueprint images when the page loads.
         */
        window.onload = async () => {
            applySavedTheme(); // Apply theme first
            try {
                // Assuming weapon.json will be a static asset served by Vercel
                const response = await fetch('weapon.json'); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                jsonData = data; // Set global data
                updateJsonDisplay(); // Format and display initial JSON in both areas
                populateWeaponSelect();
                populateImageUploadWeaponSelect(); // Populate image upload dropdown
                showMessage('weapon.json loaded successfully!', 'success');
            } catch (error) {
                jsonInput.value = '/* Failed to load weapon.json. Ensure it\'s in the same directory as this HTML file (or accessible as a static asset). Please load a file manually or paste JSON. */';
                jsonOutput.value = '';
                showMessage(`Could not load weapon.json: ${error.message}`, 'error');
                console.error('Error loading initial JSON:', error);
            }

            // Load blueprint images based on weapon data after JSON is loaded
            loadBlueprintImages();
            setupClickablePlaceholders(); // Setup listeners for placeholders after initial load
        };

        // Event listener for the Refresh Images button
        refreshImagesBtn.addEventListener('click', () => {
            loadBlueprintImages();
            setupClickablePlaceholders(); // Re-apply listeners after images are reloaded
        });

    </script>
</body>
</html>
