<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blu Base - Verification</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Open+Sans:wght@400;600&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://files.catbox.moe/pucbmh.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="verify_style.css" />
  <meta property="og:title" content="Blu Base" />
  <meta property="og:description" content="your no.1 bp pull db!" />
  <meta property="og:image" content="https://files.catbox.moe/pucbmh.png" />
  <meta property="og:url" content="https://parsegod.github.io/BP-Pull-DB/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Blu Base" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Blu Base">
  <meta name="twitter:description" content="your no.1 bp pull db!">
  <meta name="twitter:image" content="https://files.catbox.moe/pucbmh.png">

  <link rel="preload" href="assets/wallpaper.mp4" as="video" type="video/mp4">
</head>
<body class="modal-open">
  <div class="video-background">
    <video id="backgroundVideo" autoplay loop muted playsinline>
      <source src="assets/wallpaper.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <div id="verificationModal" class="verification-modal-overlay">
    <div class="verification-modal-content scale-in">
      <h2 id="verificationTitle">Account Verification Required</h2>
      <p id="verificationInstruction">
        To maintain the integrity of our database and prevent spam entries, we require a quick verification.
      </p>
      <p id="verificationNote" class="glowing-red-text">
        A new tab will open for the verification. If the modal doesn't close automatically, please close the verification tab.
      </p>
      <div id="verificationSuccessMessage">
        <svg class="success-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/></svg>
        Verification Successful!
        <br>

        <div id="loadingContainerInModal" style="display: none;">
            <div id="loadingBarContainer">
                <div id="loadingBar"></div>
            </div>
            <div id="loadingText">Generating API Key- 0%</div>
        </div>
        <div id="apiKeyDisplay"></div>
      </div>
      <button id="verifyButton">Verify Your IP</button>

    </div>
  </div>

  <div id="customMessageBox"></div>

  <div id="clearMessagePopup" class="hidden">
    <div>
        Local storage cleared. You will be redirected to the verification page.
    </div>
  </div>

  <div id="apiKeyDurationPopupOverlay" class="verification-modal-overlay">
    <div id="apiKeyDurationPopupContent" class="verification-modal-content scale-in">
        <h3>Configure API Key Duration</h3>
        <p>Choose how long your API key should remain valid:</p>
        <div class="duration-options">
            <div class="duration-option">
                <input type="radio" id="duration2h" name="apiKeyDuration" value="2" checked>
                <label for="duration2h">2 Hours (Default)</label>
            </div>
            <div class="duration-option">
                <input type="radio" id="duration12h" name="apiKeyDuration" value="12">
                <label for="duration12h">12 Hours</label>
            </div>
            <div class="duration-option">
                <input type="radio" id="duration24h" name="apiKeyDuration" value="24">
                <label for="duration24h">24 Hours</label>
            </div>
            <div class="duration-option">
                <input type="radio" id="duration7d" name="apiKeyDuration" value="168">
                <label for="duration7d">7 Days</label>
            </div>
            <div class="duration-option">
                <input type="radio" id="durationCustom" name="apiKeyDuration" value="custom">
                <label for="durationCustom">Custom Duration</label>
            </div>
            <div class="custom-duration-input-container" id="customDurationContainer">
                <div class="custom-duration-input-group">
                    <input type="number" id="customMonthsInput" placeholder="0" min="0" max="120">
                    <label for="customMonthsInput">Months</label>
                </div>
                <div class="custom-duration-input-group">
                    <input type="number" id="customDaysInput" placeholder="0" min="0" max="365">
                    <label for="customDaysInput">Days</label>
                </div>
                <div class="custom-duration-input-group">
                    <input type="number" id="customHoursInput" placeholder="0" min="0" max="23">
                    <label for="customHoursInput">Hours</label>
                </div>
                <div class="custom-duration-input-group">
                    <input type="number" id="customMinutesInput" placeholder="0" min="0" max="59">
                    <label for="customMinutesInput">Minutes</label>
                </div>
            </div>
        </div>
        <button id="confirmDurationButton">Confirm Duration</button>
    </div>
  </div>

  <div id="apiKeyPopupOverlay" class="verification-modal-overlay">
    <div id="apiKeyPopupContent" class="verification-modal-content scale-in">
        <h3>Verification Aftermath</h3>
        <p><strong>IP:</strong> <span id="popupUserIp"></span></p>
        <p><strong>API Key:</strong> <span id="popupApiKey"></span></p>
        <p><strong>Valid Until:</strong> <span id="popupApiKeyExpiry"></span></p>
        <p><strong>API Login:</strong> <span id="popupApiLoginStatus" class="status-no-permission">NO PERMISSION</span></p>
        <p><strong>IP Blacklist Status:</strong> <span id="popupBlacklistStatus"></span></p>
        <p><strong>Generation Log:</strong></p>
        <div id="popupGenerationLog" class="generation-log-container"></div>
        <button id="apiKeyPopupButton">Proceed to Home</button>
    </div>
  </div>

  <script>
    // Helper function for delays
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // Helper function to get user's public IP (still useful for initial display or local checks)
    async function getUserIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error("Error fetching IP address:", error);
            return null;
        }
    }

    // This function is now primarily for checking if an API key exists and redirecting
    function initializeVerificationModal() {
      const apiKey = localStorage.getItem('blubase_api_key');
      const apiKeyExpiry = localStorage.getItem('blubase_api_key_expiry');
      const originalApiKey = localStorage.getItem('blubase_api_key_original');
      const currentTime = new Date().getTime();

      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
      const isKeyValidFormat = apiKey && uuidRegex.test(apiKey);
      const isKeyNotTampered = originalApiKey && apiKey === originalApiKey;
      const isKeyNotExpired = apiKeyExpiry && currentTime < parseInt(apiKeyExpiry);

      if (isKeyValidFormat && isKeyNotTampered && isKeyNotExpired) {
        console.log("User has a valid, untampered API key. Redirecting to home.");
        window.location.href = '/home'; // Redirect to your main application page
        return;
      } else if (apiKey || apiKeyExpiry || originalApiKey) {
        // If key exists but is invalid/tampered/expired, clear it
        console.log("Invalid or tampered API key found. Clearing local storage.");
        localStorage.removeItem('blubase_api_key');
        localStorage.removeItem('blubase_api_key_expiry');
        localStorage.removeItem('blubase_api_key_original');
      }

      // If no valid key, show the verification modal
      document.body.classList.add('modal-open');
      verificationTitle.style.display = 'block';
      verificationInstruction.style.display = 'block';
      verificationNote.style.display = 'block';
      verifyButton.style.display = 'inline-block';
      verificationSuccessMessage.style.display = 'none';
      apiKeyDisplay.style.display = 'none';
      loadingContainerInModal.style.display = 'none';
      verifyButton.disabled = false;
    }

    // --- Main API Key Generation Logic (Calls Backend) ---
    async function simulateApiKeyGeneration(durationHours) {
        generationLogMessages = [];

        loadingContainerInModal.style.display = 'flex';
        loadingContainerInModal.style.opacity = '1';

        let currentProgress = 0;
        const updateProgressBar = (percentage) => {
            currentProgress = percentage;
            loadingBar.style.width = `${percentage}%`;
            loadingText.textContent = `Generating API Key- ${Math.floor(percentage)}%`;
        };

        const addLogMessage = (message) => {
            const timestamp = new Date().toLocaleTimeString();
            const fullMessage = `[${timestamp}] ${message}`;
            generationLogMessages.push(fullMessage);
        };

        let newApiKey = "N/A";
        let expiryTime = null; // Will store the timestamp from the backend
        let apiLoginStatus = "NO PERMISSION"; // Default status
        let backendUserIp = "UNKNOWN"; // To store the IP reported by the backend
        let backendIpBlacklistStatus = "UNKNOWN"; // To store the blacklist status from the backend

        addLogMessage("Initiating API Key Generation via Backend...");
        updateProgressBar(5);
        await delay(300);

        try {
            addLogMessage("Sending request to backend for key generation...");
            updateProgressBar(20);
            await delay(500);

            // --- IMPORTANT: Replace with your actual backend URL ---
            // Example for Vercel: 'https://your-blunet-backend.vercel.app/api/generate-key'
            const backendUrl = 'YOUR_VERCEL_DEPLOYMENT_URL/api/generate-key'; // <--- CHANGE THIS LINE

            const response = await fetch(backendUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ durationHours: durationHours }),
            });

            updateProgressBar(50);
            await delay(500);

            const data = await response.json();

            if (response.ok) {
                newApiKey = data.apiKey;
                expiryTime = data.expiryTime; // This is a timestamp
                backendUserIp = data.userIp;
                backendIpBlacklistStatus = data.ipBlacklistStatus;

                addLogMessage(`Backend response received. IP: ${backendUserIp}, Blacklist Status: ${backendIpBlacklistStatus}`);
                addLogMessage(`Generated API Key: ${newApiKey}`);
                addLogMessage(`Key expires: ${expiryTime ? new Date(expiryTime).toLocaleString() : 'N/A'}`);
                apiLoginStatus = "SUCCESS"; // Key successfully generated

                updateProgressBar(80);
                await delay(500);

            } else {
                // Handle errors from the backend (e.g., invalid duration, blacklisted IP)
                addLogMessage(`Backend Error: ${data.message || 'Unknown error'}`);
                if (data.ipBlacklistStatus === 'BLOCKED') {
                    backendIpBlacklistStatus = 'BLOCKED';
                    addLogMessage("IP was blocked by backend blacklist.");
                }
                apiLoginStatus = "FAILED";
                updateProgressBar(70); // Indicate failure progress
                await delay(500);
            }

        } catch (error) {
            addLogMessage(`Network or unexpected error: ${error.message}`);
            apiLoginStatus = "FAILED";
            updateProgressBar(60); // Indicate failure progress
            await delay(500);
        } finally {
            updateProgressBar(100);
            loadingText.textContent = "Generation Complete!";
            await delay(500); // Shorten final delay before showing popup

            // Store the API key if successful
            if (apiLoginStatus === "SUCCESS") {
                localStorage.setItem('blubase_api_key', newApiKey);
                localStorage.setItem('blubase_api_key_expiry', expiryTime.toString());
                localStorage.setItem('blubase_api_key_original', newApiKey); // Store original for tampering check
                addLogMessage("API key successfully stored in local storage.");
            } else {
                addLogMessage("API key generation failed. Not storing key.");
            }

            // Hide loading elements
            loadingContainerInModal.style.opacity = '0';
            loadingContainerInModal.style.display = 'none';

            // Populate and show the final API Key Popup
            popupUserIp.textContent = backendUserIp;
            popupApiKey.textContent = newApiKey;
            popupApiKeyExpiry.textContent = expiryTime ? new Date(expiryTime).toLocaleString('en-US', {
                month: 'numeric', day: 'numeric', year: 'numeric',
                hour: 'numeric', minute: 'numeric', second: 'numeric',
                hour12: true, timeZoneName: 'short', timeZone: 'America/Denver'
            }) : 'N/A';
            popupApiLoginStatus.textContent = apiLoginStatus;
            popupApiLoginStatus.className = `status-${apiLoginStatus.toLowerCase().replace(/\s/g, '-')}`;
            popupBlacklistStatus.textContent = backendIpBlacklistStatus;
            popupBlacklistStatus.className = `status-${backendIpBlacklistStatus.toLowerCase().replace(/\s/g, '-')}`;
            popupGenerationLog.innerHTML = generationLogMessages.join('<br>');

            apiKeyPopupOverlay.classList.add('show'); // Show the final popup

            apiKeyPopupButton.onclick = () => {
                // If this window was opened by another (e.g., index.html), close it.
                // Otherwise, redirect to home.
                if (window.opener && !window.opener.closed) {
                    window.close();
                } else {
                    window.location.href = '/home'; // Redirect to your main application page
                }
            };
        }
    }

    function showApiKeyDurationPopup() {
        // Hide main verification elements
        verificationTitle.style.display = 'none';
        verificationInstruction.style.display = 'none';
        verificationNote.style.display = 'none';
        verifyButton.style.display = 'none';

        // Show success message and then the duration popup
        verificationSuccessMessage.style.display = 'block';
        loadingContainerInModal.style.display = 'none'; // Ensure loading is hidden

        apiKeyDurationPopupOverlay.classList.add('show');
        customDurationContainer.classList.remove('show'); // Hide custom input initially

        // Reset custom inputs and default radio button
        customMonthsInput.value = '';
        customDaysInput.value = '';
        customHoursInput.value = '';
        customMinutesInput.value = '';
        document.getElementById('duration2h').checked = true;
    }

    function handleVerificationSuccess() {
        if (window.checkWindowClosedInterval) {
            clearInterval(window.checkWindowClosedInterval);
            window.checkWindowClosedInterval = null;
            console.log("Cleared existing checkWindowClosedInterval in handleVerificationSuccess.");
        }
        verifyButton.disabled = true;
        showApiKeyDurationPopup(); // Proceed to duration selection
    }

    // --- DOM Element References ---
    const verificationModal = document.getElementById('verificationModal');
    const verifyButton = document.getElementById('verifyButton');

    const verificationTitle = document.getElementById('verificationTitle');
    const verificationInstruction = document.getElementById('verificationInstruction');
    const verificationNote = document.getElementById('verificationNote');
    const verificationSuccessMessage = document.getElementById('verificationSuccessMessage');
    const loadingContainerInModal = document.getElementById('loadingContainerInModal');
    const loadingBar = document.getElementById('loadingBar');
    const loadingText = document.getElementById('loadingText');
    const apiKeyDisplay = document.getElementById('apiKeyDisplay'); // This might be redundant now, check your CSS/HTML

    const customMessageBox = document.getElementById('customMessageBox');
    const clearMessagePopup = document.getElementById('clearMessagePopup'); // Not used in this flow, but kept for completeness

    const apiKeyDurationPopupOverlay = document.getElementById('apiKeyDurationPopupOverlay');
    const apiKeyDurationPopupContent = document.getElementById('apiKeyDurationPopupContent');
    const confirmDurationButton = document.getElementById('confirmDurationButton');

    const customMonthsInput = document.getElementById('customMonthsInput');
    const customDaysInput = document.getElementById('customDaysInput');
    const customHoursInput = document.getElementById('customHoursInput');
    const customMinutesInput = document.getElementById('customMinutesInput');
    const customDurationContainer = document.getElementById('customDurationContainer');
    const durationRadioButtons = document.querySelectorAll('input[name="apiKeyDuration"]');

    const apiKeyPopupOverlay = document.getElementById('apiKeyPopupOverlay');
    const popupUserIp = document.getElementById('popupUserIp');
    const popupApiKey = document.getElementById('popupApiKey');
    const popupApiKeyExpiry = document.getElementById('popupApiKeyExpiry');
    const popupApiLoginStatus = document.getElementById('popupApiLoginStatus');
    const popupBlacklistStatus = document.getElementById('popupBlacklistStatus');
    const popupGenerationLog = document.getElementById('popupGenerationLog');
    const apiKeyPopupButton = document.getElementById('apiKeyPopupButton');

    let verificationWindow = null;
    let generationLogMessages = []; // Re-declared here for global scope within this script
    let capturedUserIP = "N/A"; // This will be populated by backend response now
    let selectedApiKeyDurationHours = 2;

    // --- Event Listeners ---
    durationRadioButtons.forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.value === 'custom') {
                customDurationContainer.classList.add('show');
                customMonthsInput.focus();
            } else {
                customDurationContainer.classList.remove('show');
            }
        });
    });

    confirmDurationButton.addEventListener('click', () => {
        const selectedDurationRadio = document.querySelector('input[name="apiKeyDuration"]:checked');
        let totalDurationHours = 0;

        if (selectedDurationRadio) {
            if (selectedDurationRadio.value === 'custom') {
                const months = parseInt(customMonthsInput.value) || 0;
                const days = parseInt(customDaysInput.value) || 0;
                const hours = parseInt(customHoursInput.value) || 0;
                const minutes = parseInt(customMinutesInput.value) || 0;

                totalDurationHours = (months * 30 * 24) + (days * 24) + hours + (minutes / 60);

                if (totalDurationHours <= 0 || totalDurationHours > (365 * 5 * 24)) {
                    customMessageBox.textContent = "Please enter a valid custom duration (max 5 years).";
                    customMessageBox.style.display = 'block';
                    setTimeout(() => {
                        customMessageBox.style.display = 'none';
                    }, 4000);
                    return;
                }
            } else {
                totalDurationHours = parseInt(selectedDurationRadio.value);
            }
        }

        selectedApiKeyDurationHours = totalDurationHours;
        apiKeyDurationPopupOverlay.classList.remove('show');
        simulateApiKeyGeneration(selectedApiKeyDurationHours);
    });

    verifyButton.addEventListener('click', () => {
      console.log("Verify button clicked!");

      // No IP blacklist check here, as it's handled by the backend and initial verification.js
      // This button is specifically for opening the external verification window.

      if (window.checkWindowClosedInterval) {
        clearInterval(window.checkWindowClosedInterval);
        console.log("Cleared existing checkWindowClosedInterval.");
      }

      // Open the external verification URL
      verificationWindow = window.open('https://vdax.rf.gd/', '_blank');
      console.log("Verification window opened. Reference:", verificationWindow);

      if (!verificationWindow || verificationWindow.closed || typeof verificationWindow.closed === 'undefined') {
          customMessageBox.textContent = "Pop-up blocked or failed to open! Please allow pop-ups for this site.";
          customMessageBox.style.display = 'block';
          setTimeout(() => {
            customMessageBox.style.display = 'none';
          }, 3000);
          console.error("Pop-up window was blocked or failed to open.");
          return;
      }

      // Start checking if the external verification window is closed
      window.checkWindowClosedInterval = setInterval(() => {
        if (verificationWindow && verificationWindow.closed) {
          clearInterval(window.checkWindowClosedInterval);
          window.checkWindowClosedInterval = null;
          console.log("Verification window closed. Calling handleVerificationSuccess.");
          handleVerificationSuccess(); // This will now trigger duration selection and API key generation
        }
      }, 1000);
    });

    // Initialize the verification modal on page load
    document.addEventListener('DOMContentLoaded', initializeVerificationModal);
  </script>
</body>
</html>
